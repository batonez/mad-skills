<!doctype html>
<html>
  <head>
    <title>Skill Tree</title>
    <meta charset='utf-8' />
    <style>
      html {
        color: #66391A;
      }
      
      #main-canvas {
        float: left;
      }
      
      #controls {
        padding-left: 7px;
        overflow: hidden;
      }
      
      #save {
        margin-top: 8px;
      }
      
      #message {
        margin-top: 8px;
        background-color: #FFDDEE;
      }
      
      fieldset {
        border: none;
      }
    </style>
  </head>
  <body oncontextmenu="return false;">
    <canvas id='main-canvas'>Canvas failed to load. Are you sure that your browser is from this century?</canvas>
    <div id="controls">
      <fieldset>
        <button id="delete-rect">Delete Skill</button>
        <button id="place-rect">Create Skill:</button>
        <input  id="skill-name" type="text" value=""></input>
      </fieldset>
      
      <fieldset>
        <button id="delete-link">Delete Link</button>
        <button id="create-link">Create Link:</button>
        <input  id="link-weight" type="number" step="any" min="0" max="1" value=""></input>
      </fieldset>
    
      <fieldset>
        <button id="save">Save</button>
      </fieldset>
      <div id="message"></div>
    </div>
    
    <script src="geometry.js"></script>
    <script>
      function redraw()
      {
        ctx.fillStyle = "#EEEEEE";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        for (var i in rects) {          
          var parents = rects[i].parents;
          
          for (var pKey in parents)
            drawArrowBetweenRects(ctx, rects[i], rects[pKey], rects[i]["parents"][pKey], translation);

          drawRect(ctx, rects[i], i, translation);
          prev = i;
        }
      }

      function makeCounter()
      {
        var i = Math.max.apply(Math, Object.keys(rects));
        return function() { return ++i; }
      }

      function getMousePositionOnCanvas(canvas, mouseEvent)
      {
        var canvasBounds = canvas.getBoundingClientRect();
        return {
          x: mouseEvent.clientX - canvasBounds.left,
          y: mouseEvent.clientY - canvasBounds.top
        };
      }

      function getRectIndexAtCoord(x, y)
      {
        for (var i in rects) {
          if (isPointInsideRect(rects[i], x, y, translation)) {
            return i;
          }
        }

        return undefined;
      }

      function showMessage(text)
      {
        document.getElementById("message").innerHTML = text;
      }
////////////////////////////////////////////////////////////////////////////////

      var canvas = document.getElementById("main-canvas");
      var w = window;
      var d = document;
      var e = d.documentElement;
      var g = d.getElementsByTagName('body')[0];
      //canvas.width = w.innerWidth || e.clientWidth || g.clientWidth;
      //canvas.height = w.innerHeight|| e.clientHeight|| g.clientHeight;
      canvas.width = g.clientWidth - 500;
      canvas.height = e.clientHeight - 20;
      var ctx    = canvas.getContext('2d');
      
      var xhr = new XMLHttpRequest();
      xhr.open('GET', 'skills.json', false);
      xhr.send();

      if (xhr.status != 200) {
        alert( xhr.status + ': ' + xhr.statusText );
      } else {
        rects = JSON.parse(xhr.responseText);
      }

      var Action = {
        DRAG: 0,
        CREATE_NODE: 1,
        DELETE_NODE: 2,
        CREATE_LINK: 3,
        DELETE_LINK: 4
      };

      var action = Action.DRAG;
      var getNextKey  = makeCounter();
      var draggedRect = undefined;
      var dragCorrectionX = undefined;
      var dragCorrectionY = undefined;
      var selectLinkParentKey = undefined;
      var translating = false;
      var translation = {x: 0, y: 0};
      var prevMouseX = undefined;
      var prevMouseY = undefined;

      redraw();

      canvas.onmousedown = function(e) {
        var mouse = getMousePositionOnCanvas(canvas, e);
        if (e.button == 2) {
          translating = true;
          prevMouseX = mouse.x;
          prevMouseY = mouse.y;
          return;
        }
        
        var clickedRectKey = getRectIndexAtCoord(mouse.x, mouse.y);
        var clickedRect = rects[clickedRectKey];

        if (action == Action.CREATE_NODE) {
          if (clickedRect != undefined) {
            return;
          }

          rects[getNextKey()] = {
            "x": mouse.x,
            "y": mouse.y,
            "width": 50,
            "height": 50,
            "text": document.getElementById("skill-name").value,
            "value": 0,
            "parents": {}
          };

          action = Action.DRAG;
          document.getElementById("place-rect").innerHTML = "Create Skill";
          document.getElementById("skill-name").value = "";
          showMessage("");
          redraw();
        } else if (action == Action.CREATE_LINK || action == Action.DELETE_LINK) {
          if (selectLinkParentKey == undefined) {
            selectLinkParentKey = clickedRectKey;
          }
        } else if (action == Action.DRAG) {
          draggedRect = clickedRect;
          dragCorrectionX = mouse.x - draggedRect.x;
          dragCorrectionY = mouse.y - draggedRect.y;
        }
      };

      canvas.onmouseup = function(e) {
        translating = false;
        prevMouseX = undefined;
        prevMouseY = undefined;
        draggedRect = undefined;
        dragCorrectionX = undefined;
        dragCorrectionY = undefined;
        var mouse = getMousePositionOnCanvas(canvas, e);
        var i = getRectIndexAtCoord(mouse.x, mouse.y);
        
        if (action == Action.DELETE_NODE) {
          if (i == undefined) {
            return;
          }

          for (var j in rects) {
            for (var parentKey in rects[j]["parents"]) {
              if (parentKey == i) {
                delete rects[j]["parents"][parentKey];
              }
            }
          }

          delete rects[i];
          action = Action.DRAG
          document.getElementById("delete-rect").innerHTML = "Delete Skill";
          showMessage("");
          redraw();
        } else if (action == Action.CREATE_LINK) {
          if (selectLinkParentKey != undefined && selectLinkParentKey != i) {
            if (!rects[i]["parents"].hasOwnProperty(selectLinkParentKey)) {
              rects[i]["parents"][selectLinkParentKey] = document.getElementById("link-weight").value;
            }
            
            action = Action.DRAG;
            selectLinkParentKey = undefined;
            document.getElementById("create-link").innerHTML = "Create Link";
            document.getElementById("link-weight").value = "";
            showMessage("");
            redraw();
          }
        } else if (action == Action.DELETE_LINK) {
          if (selectLinkParentKey != undefined && selectLinkParentKey != i) {
            for (var parentKey in rects[i]["parents"])
            {
              if (parentKey == selectLinkParentKey) {
                delete rects[i]["parents"][parentKey];
                break;
              }
            }
            
            action = Action.DRAG;
            selectLinkParentKey = undefined;
            document.getElementById("delete-link").innerHTML = "Delete Link";
            showMessage("");
            redraw();
          }
        }
      };

      canvas.onmousemove = function(e) {
        if (draggedRect != undefined) {
          var mouse = getMousePositionOnCanvas(canvas, e);

          draggedRect.x = mouse.x - dragCorrectionX;
          draggedRect.y = mouse.y - dragCorrectionY;

          redraw();
        } else if (translating) {
          var mouse = getMousePositionOnCanvas(canvas, e);

          translation.x += mouse.x - prevMouseX;
          translation.y += mouse.y - prevMouseY;
          
          prevMouseX = mouse.x;
          prevMouseY = mouse.y;

          redraw();          
        }
      };

      document.getElementById("save").onclick = function() {
        var xhr = new XMLHttpRequest()
        xhr.open('POST', 'skill_server.php', false);
          xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded')
        xhr.send("skills=" + JSON.stringify(rects));

        if (xhr.status != 200) {
          alert( xhr.status + ': ' + xhr.statusText );
        }
      }

      document.getElementById("place-rect").onclick = function() {
        action = (action == Action.CREATE_NODE ? Action.DRAG : Action.CREATE_NODE);
        document.getElementById("place-rect").innerHTML = (action == Action.CREATE_NODE ? "Cancel" : "Create Skill");
        showMessage(action == Action.DRAG ? "" : "Enter the name of a skill and select an empty spot to place it at");
      }

      document.getElementById("delete-rect").onclick = function() {
        action = (action == Action.DELETE_NODE ? Action.DRAG : Action.DELETE_NODE);
        document.getElementById("delete-rect").innerHTML = (action == Action.DELETE_NODE ? "Cancel" : "Delete Skill");
        showMessage(action == Action.DRAG ? "" : "Select a skill to delete");
      }

      document.getElementById("create-link").onclick = function() {
        action = (action == Action.CREATE_LINK ? Action.DRAG : Action.CREATE_LINK);
        document.getElementById("create-link").innerHTML = (action == Action.CREATE_LINK ? "Cancel" : "Create Link");
        showMessage(action == Action.DRAG ? "" : "Enter link weight, select a parent skill, then select a child to create a link");
      }

      document.getElementById("delete-link").onclick = function() {
        action = (action == Action.DELETE_LINK ? Action.DRAG : Action.DELETE_LINK);
        document.getElementById("delete-link").innerHTML = (action == Action.DELETE_LINK ? "Cancel" : "Delete Link");
        showMessage(action == Action.DRAG ? "" : "Select a parent skill, then a child to delete a link");
      }
    </script>
  </body>
</html>

