<!doctype html>
<html>
  <head>
    <title>Skill Tree</title>
    <meta charset='utf-8' />
  </head>
  <body>
    <canvas id='main-canvas'>Canvas failed to load. Are you sure that your browser is from this century?</canvas>
    <button id="save">Save</button>
    <button id="delete-rect">Delete Skill</button>
    <button id="create-link">Create Link</button>
    <button id="delete-link">Delete Link</button>
    <button id="place-rect">Create Skill</button>
    <label for="skill-name">Skill name:</label><input id="skill-name" type="text" value=""></input>
    
    <div id="message"></div>
    <script src="geometry.js"></script>
    <script>
      function redraw()
      {
        ctx.clearRect(0, 0, 640, 480);

        for (var i in rects) {
          if (rects[i].hasOwnProperty("parents")) {
            var parents = rects[i].parents;

            for (var pKey = 0; pKey < parents.length; pKey++)
              drawArrowBetweenRects(ctx, rects[i], rects[parents[pKey]]);
          }

          drawRect(ctx, rects[i], i);
          prev = i;
        }

        ctx.strokeStyle = "#000000";
        ctx.strokeRect(0, 0, 640, 480);
      }

      function makeCounter()
      {
        var i = Math.max.apply(Math, Object.keys(rects));
        return function() { return ++i; }
      }

      function getMousePositionOnCanvas(canvas, mouseEvent)
      {
        var canvasBounds = canvas.getBoundingClientRect();
        return {
          x: mouseEvent.clientX - canvasBounds.left,
          y: mouseEvent.clientY - canvasBounds.top
        };
      }

      function getRectIndexAtCoord(x, y)
      {
        for (var i in rects) {
          if (isPointInsideRect(rects[i], x, y)) {
            return i;
          }
        }

        return undefined;
      }

      function showMessage(text)
      {
        document.getElementById("message").innerHTML = text;
      }
////////////////////////////////////////////////////////////////////////////////

      var canvas = document.getElementById("main-canvas");
      var ctx    = canvas.getContext('2d');
      canvas.height = 480;
      canvas.width  = 640;

      var xhr = new XMLHttpRequest();
      xhr.open('GET', 'skills.json', false);
      xhr.send();

      if (xhr.status != 200) {
        alert( xhr.status + ': ' + xhr.statusText );
      } else {
        rects = JSON.parse(xhr.responseText);
      }

      var Action = {
        DRAG: 0,
        CREATE_NODE: 1,
        DELETE_NODE: 2,
        CREATE_LINK: 3,
        DELETE_LINK: 4
      };

      var action = Action.DRAG;
      var getNextKey  = makeCounter();
      var draggedRect = undefined;
      var selectLinkParentKey = undefined;

      redraw();

      canvas.onmousedown = function(e) {
        var mouse = getMousePositionOnCanvas(canvas, e);
        var clickedIndex = getRectIndexAtCoord(mouse.x, mouse.y);
        var clickedRect = rects[clickedIndex];

        if (action == Action.CREATE_NODE) {
          if (clickedRect != undefined) {
            return;
          }

          rects[getNextKey()] = {
            "x": mouse.x,
            "y": mouse.y,
            "width": 50,
            "height": 50,
            "text": document.getElementById("skill-name").value,
            "value": 0,
            "parents": []
          };

          action = Action.DRAG;
          document.getElementById("place-rect").innerHTML = "Create Skill";
          document.getElementById("skill-name").value = "";
          showMessage("");
          redraw();
        } else if (action == Action.CREATE_LINK || action == Action.DELETE_LINK) {
          if (selectLinkParentKey == undefined) {
            selectLinkParentKey = clickedIndex;
          }
        } else if (action == Action.DRAG) {
          draggedRect = clickedRect;
        }
      };

      canvas.onmouseup = function(e) {
        draggedRect = undefined;
        var mouse = getMousePositionOnCanvas(canvas, e);
        var i = getRectIndexAtCoord(mouse.x, mouse.y);
        
        if (action == Action.DELETE_NODE) {
          if (i == undefined) {
            return;
          }

          for (var j in rects) {
            for (var parentKey = 0; parentKey < rects[j]["parents"].length; parentKey++) {
              if (rects[j]["parents"][parentKey] == i) {
                rects[j]["parents"].splice(parentKey, 1);
              }
            }
          }

          delete rects[i];
          action = Action.DRAG
          document.getElementById("delete-rect").innerHTML = "Delete Skill";
          showMessage("");
          redraw();
        } else if (action == Action.CREATE_LINK) {
          if (selectLinkParentKey != undefined && selectLinkParentKey != i) {
            if (rects[i]["parents"].indexOf(selectLinkParentKey) == -1) {
              rects[i]["parents"].push(selectLinkParentKey);
            }
            
            action = Action.DRAG;
            selectLinkParentKey = undefined;
            document.getElementById("create-link").innerHTML = "Create Link";
            showMessage("");
            redraw();
          }
        } else if (action == Action.DELETE_LINK) {
          if (selectLinkParentKey != undefined && selectLinkParentKey != i) {
            for (var parentIndex = 0; parentIndex < rects[i]["parents"].length; parentIndex++)
            {
              if (rects[i]["parents"][parentIndex] == selectLinkParentKey) {
                rects[i]["parents"].splice(parentIndex, 1);
                break;
              }
            }
            
            action = Action.DRAG;
            selectLinkParentKey = undefined;
            document.getElementById("delete-link").innerHTML = "Delete Link";
            showMessage("");
            redraw();
          }
        }
      };

      canvas.onmousemove = function(e) {
        if (draggedRect == undefined) {
          return;
        }

        var mouse = getMousePositionOnCanvas(canvas, e);

        draggedRect.x = mouse.x;
        draggedRect.y = mouse.y;

        redraw();
      };

      document.getElementById("save").onclick = function() {
        var xhr = new XMLHttpRequest()
        xhr.open('POST', 'skill_server.php', false);
          xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded')
        xhr.send("skills=" + JSON.stringify(rects));

        if (xhr.status != 200) {
          alert( xhr.status + ': ' + xhr.statusText );
        }
      }

      document.getElementById("place-rect").onclick = function() {
        action = (action == Action.CREATE_NODE ? Action.DRAG : Action.CREATE_NODE);
        document.getElementById("place-rect").innerHTML = (action == Action.CREATE_NODE ? "Cancel" : "Create Skill");
        showMessage("Select an empty spot to create a skill at");
      }

      document.getElementById("delete-rect").onclick = function() {
        action = (action == Action.DELETE_NODE ? Action.DRAG : Action.DELETE_NODE);
        document.getElementById("delete-rect").innerHTML = (action == Action.DELETE_NODE ? "Cancel" : "Delete Skill");
        showMessage("Select a skill to delete");
      }

      document.getElementById("create-link").onclick = function() {
        action = (action == Action.CREATE_LINK ? Action.DRAG : Action.CREATE_LINK);
        document.getElementById("create-link").innerHTML = (action == Action.CREATE_LINK ? "Cancel" : "Create Link");
        showMessage("Select a parent skill, then a child to create a link");
      }

      document.getElementById("delete-link").onclick = function() {
        action = (action == Action.DELETE_LINK ? Action.DRAG : Action.DELETE_LINK);
        document.getElementById("delete-link").innerHTML = (action == Action.DELETE_LINK ? "Cancel" : "Delete Link");
        showMessage("Select a parent skill, then a child to delete a link");
      }
    </script>
  </body>
</html>

